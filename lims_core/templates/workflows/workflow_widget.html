<div class="workflow-widget" data-kind="{{ kind }}" data-id="{{ object_id }}">
  <div class="workflow-current">
    <strong>Status:</strong>
    <span class="workflow-status" id="wf-status">Loading…</span>
  </div>

  <div class="workflow-actions" id="wf-actions">
    <!-- buttons injected here -->
  </div>

  <div class="workflow-error text-danger" id="wf-error" style="display:none;"></div>
</div>

<script>
(async function () {
  const container = document.currentScript.parentElement;
  const kind = container.dataset.kind;
  const id = container.dataset.id;

  const statusEl = container.querySelector("#wf-status");
  const actionsEl = container.querySelector("#wf-actions");
  const errorEl = container.querySelector("#wf-error");

  function showError(msg) {
    errorEl.innerText = msg;
    errorEl.style.display = "block";
  }

  function clearError() {
    errorEl.innerText = "";
    errorEl.style.display = "none";
  }

  async function loadState() {
    clearError();
    actionsEl.innerHTML = "";
    statusEl.innerText = "Loading…";

    try {
      const stateResp = await fetch(`/lims/workflows/${kind}/${id}/`);
      if (!stateResp.ok) throw new Error("Failed to load workflow state");

      const state = await stateResp.json();
      statusEl.innerText = state.status;

      const allowedResp = await fetch(
        `/lims/workflows/${kind}/${id}/allowed/`
      );
      if (!allowedResp.ok) return;

      const allowed = await allowedResp.json();

      (allowed.allowed || []).forEach(target => {
        const btn = document.createElement("button");
        btn.innerText = target;
        btn.className = "btn btn-sm btn-outline-primary me-2";
        btn.onclick = () => transition(target);
        actionsEl.appendChild(btn);
      });

    } catch (err) {
      showError(err.message);
    }
  }

  async function transition(target) {
    clearError();

    try {
      const resp = await fetch(
        `/lims/workflows/${kind}/${id}/`,
        {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({ status: target })
        }
      );

      if (resp.status === 403) {
        showError("You are not permitted to perform this action.");
        return;
      }

      if (resp.status === 409) {
        const data = await resp.json();
        showError(data.detail || "Invalid transition.");
        return;
      }

      if (!resp.ok) {
        showError("Unexpected error.");
        return;
      }

      await loadState();

    } catch (err) {
      showError(err.message);
    }
  }

  loadState();
})();
</script>
