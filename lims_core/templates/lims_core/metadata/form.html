{% extends "lims_core/base.html" %}
{% load static %}
{% load metadata_extras %}

{% block title %}Metadata{% endblock %}
{% block page_title %}Metadata Entry{% endblock %}
{% block page_meta %}
Schema-driven metadata for {{ object_type|title }} #{{ object.id }}
{% endblock %}

{% block content %}
<div class="wrap">
  <form method="post" novalidate>
    {% csrf_token %}

    {# -------------------------------------------- #}
    {# Accreditation banner + save disable behavior #}
    {# -------------------------------------------- #}
    {% if any_schema_unlocked %}
      <div class="alert alert-warning" style="margin-bottom:14px;">
        <strong>Accreditation mode safeguard:</strong>
        This metadata schema is not locked. Editing is allowed for preparation,
        but saving is disabled until the schema is formally locked.
      </div>
    {% else %}
      {% if accreditation_mode %}
        <div class="alert alert-success" style="margin-bottom:14px;">
          <strong>Accreditation mode:</strong> Metadata schema is locked and compliant.
        </div>
      {% endif %}
    {% endif %}

    {% for schema in schemas %}
      {% with schema_error=errors|get_item:schema.code %}
      <section class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <h3 style="margin:0;">{{ schema.name }}</h3>
          {% if schema.description %}
            <p class="muted">{{ schema.description }}</p>
          {% endif %}
          {% if accreditation_mode %}
            <div style="margin-top:8px;">
              {% if schema.is_locked %}
                <span class="badge badge-success">LOCKED</span>
              {% else %}
                <span class="badge badge-warn">DRAFT</span>
              {% endif %}
            </div>
          {% endif %}
        </div>

        <div class="card-body">
          {% if schema_error %}
            <div class="alert alert-danger">
              This section has validation errors.
            </div>
          {% endif %}

          {% for field in schema.fields.all %}
            {% with field_code=field.code %}
            {% with field_value=values|get_item:field_code %}

            <div class="form-group mb-3">
              <label for="{{ field_code }}">
                {{ field.label }}
                {% if field.required %}
                  <span class="text-danger">*</span>
                {% endif %}
              </label>

              {# Renderer contract: each renderer outputs ONLY the control #}
              {% include field.renderer_template with
                   field=field
                   value=field_value
                   values=values
                   disable_submit=disable_submit
              %}

              {% if schema_error %}
                {% with missing=schema_error|get_item:'missing' %}
                {% with invalid=schema_error|get_item:'invalid' %}
                  {% if missing and field_code in missing %}
                    <div class="error-text">This field is required.</div>
                  {% endif %}
                  {% if invalid and field_code in invalid %}
                    <div class="error-text">Invalid value.</div>
                  {% endif %}
                {% endwith %}
                {% endwith %}
              {% endif %}
            </div>

            {% endwith %}
            {% endwith %}
          {% endfor %}
        </div>
      </section>
      {% endwith %}
    {% endfor %}

    <div style="margin-top:16px;">
      <button type="submit" class="btn btn-primary" {% if disable_submit %}disabled aria-disabled="true"{% endif %}>
        Save Metadata
      </button>
      <a href="javascript:history.back()" class="btn btn-secondary">
        Cancel
      </a>
    </div>
  </form>
</div>
{% endblock %}
