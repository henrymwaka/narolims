{% extends "lims_core/base.html" %}
{% load static %}

{% block title %}Samples{% endblock %}
{% block page_title %}Samples{% endblock %}
{% block page_meta %}
  <span class="muted">Showing up to 500 most recent</span>
{% endblock %}

{% block extra_head %}
<style>
  .toolbar {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    padding: 12px;
    margin-bottom: 14px;
  }

  .toolbar-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .field label {
    display: block;
    font-weight: 700;
    font-size: 12px;
    margin-bottom: 4px;
  }

  .field select,
  .field input {
    height: 34px;
    padding: 6px 10px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    min-width: 220px;
  }

  .btn {
    height: 34px;
    padding: 0 12px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #111827;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .tiny {
    font-size: 12px;
    color: #6b7280;
    margin-top: 6px;
  }

  .table-wrap {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
  }

  table.samples {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  table.samples thead th {
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
    color: #6b7280;
    background: #fbfbfd;
    border-bottom: 1px solid #e5e7eb;
    padding: 10px 12px;
  }

  table.samples tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
  }

  table.samples tbody tr:hover {
    background: #fafafa;
  }

  .pill {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    font-weight: 700;
    font-size: 12px;
    background: #fff;
  }

  .sla-pill {
    display: inline-block;
    padding: 3px 9px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    border: 1px solid #e5e7eb;
  }

  .sla-ok { background: #e6f4ea; color: #137333; }
  .sla-warning { background: #fff4e5; color: #b06000; }
  .sla-breached { background: #fdecea; color: #b00020; }
  .sla-na { background: #f3f4f6; color: #6b7280; }

  .batch-context {
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
  }

  .batch-context a {
    color: #2563eb;
    text-decoration: none;
  }

  .batch-context a:hover {
    text-decoration: underline;
  }
</style>
{% endblock %}

{% block content %}

<div class="toolbar">
  <div class="toolbar-row">
    <div class="field">
      <label for="bulk-target">Target status</label>
      <select id="bulk-target">
        <option value="">-- choose --</option>
        {% for st in workflow_statuses %}
          <option value="{{ st }}">{{ st }}</option>
        {% endfor %}
      </select>
      <div class="tiny">statuses: {{ workflow_statuses|length }}</div>
    </div>

    <div class="field" style="flex:1;">
      <label for="bulk-comment">Comment</label>
      <input id="bulk-comment" type="text" placeholder="optional note">
    </div>

    <div>
      <button class="btn" id="bulk-apply" disabled>Apply</button>
      <div class="tiny"><span id="bulk-count">0 selected</span></div>
    </div>
  </div>
</div>

<div class="table-wrap">
  <table class="samples">
    <thead>
      <tr>
        <th><input type="checkbox" id="check-all"></th>
        <th>ID</th>
        <th>Sample</th>
        <th>Status</th>
        <th>SLA</th>
        <th>Link</th>
      </tr>
    </thead>

    <tbody>
      {% for s in samples %}
      <tr>
        <td><input class="row-check" type="checkbox" value="{{ s.id }}"></td>
        <td>{{ s.id }}</td>

        <td>
          <strong>{{ s.sample_id|default:"(unlabeled)" }}</strong>
          {% if s.batch %}
            <div class="batch-context">
              Batch:
              <a href="/lims/ui/batches/{{ s.batch.id }}/">
                {{ s.batch.batch_code }}
              </a>
            </div>
          {% endif %}
        </td>

        <td>
          <span class="pill">{{ s.safe_status }}</span>
        </td>

        <td>
          {% if s.sla %}
            <span class="sla-pill sla-{{ s.sla.status }}">
              {{ s.sla.status|upper }}
            </span>
          {% else %}
            <span class="sla-pill sla-na">N/A</span>
          {% endif %}
        </td>

        <td>
          <a href="/lims/ui/samples/{{ s.id }}/">open</a>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6">No samples found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  window.NAROLIMS_UI = window.NAROLIMS_UI || {};
  window.NAROLIMS_UI.bulkUrl = "/lims/workflows/sample/bulk/";
  window.NAROLIMS_UI.labId = "{{ lab_id }}";
</script>
<script src="{% static 'lims_core/js/workflow_bulk.js' %}?v=4"></script>

{% endblock %}
