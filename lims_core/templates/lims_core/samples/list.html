{% extends "lims_core/base.html" %}
{% load static %}

{% block title %}Samples{% endblock %}
{% block page_title %}Samples{% endblock %}
{% block page_meta %}
  <span class="muted">Showing up to 500 most recent</span>
{% endblock %}

{% block extra_head %}
<style>
  .toolbar {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    padding: 12px;
    margin-bottom: 14px;
  }

  .toolbar-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex-wrap: wrap;
  }

  .field label {
    display: block;
    font-weight: 700;
    font-size: 12px;
    margin-bottom: 4px;
  }

  .field select,
  .field input {
    height: 34px;
    padding: 6px 10px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    min-width: 220px;
  }

  .btn {
    height: 34px;
    padding: 0 12px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #111827;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .tiny {
    font-size: 12px;
    color: #6b7280;
    margin-top: 6px;
  }

  .table-wrap {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
  }

  table.samples {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  table.samples thead th {
    text-align: left;
    font-size: 12px;
    letter-spacing: .3px;
    text-transform: uppercase;
    color: #6b7280;
    background: #fbfbfd;
    border-bottom: 1px solid #e5e7eb;
    padding: 10px 12px;
  }

  table.samples tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
  }

  table.samples tbody tr:hover {
    background: #fafafa;
  }

  .col-check { width: 44px; }
  .col-id    { width: 80px; }
  .col-sid   { width: 320px; }
  .col-stat  { width: 200px; }
  .col-link  { width: 110px; }

  .pill {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    font-weight: 700;
    font-size: 12px;
    background: #fff;
  }

  a.inline-link {
    color: #111827;
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  #bulk-error {
    display: none;
    margin-top: 10px;
    color: #b00020;
    font-size: 13px;
  }

  #bulk-result {
    display: none;
    margin-top: 10px;
    background: #f7f7f7;
    padding: 10px;
    border-radius: 10px;
    overflow: auto;
    max-height: 260px;
    font-size: 12px;
  }

  @media (max-width: 720px) {
    .field select,
    .field input {
      min-width: 180px;
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block content %}

<div style="margin-bottom: 10px;">
  <a class="inline-link" href="/lims/ui/workflow-demo/">Workflow demo</a>
</div>

<div class="toolbar">
  <div class="toolbar-row">
    <div class="field">
      <label for="bulk-target">Target status</label>
      <select id="bulk-target">
        <option value="">-- choose --</option>
        {% for st in workflow_statuses %}
          <option value="{{ st }}">{{ st }}</option>
        {% endfor %}
      </select>

      {# JS updates this after fetching statuses #}
      <div class="tiny">statuses: <span id="bulk-status-count">{{ workflow_statuses|length }}</span></div>
    </div>

    <div class="field" style="flex:1; min-width: 260px;">
      <label for="bulk-comment">Comment</label>
      <input id="bulk-comment" type="text" placeholder="optional note" style="width:100%;">
    </div>

    <div>
      <button class="btn" id="bulk-apply" disabled>Apply to selected</button>
      <div class="tiny"><span id="bulk-count">0 selected</span></div>
    </div>
  </div>

  <div id="bulk-error"></div>
  <pre id="bulk-result"></pre>
</div>

<div class="table-wrap">
  <table class="samples">
    <thead>
      <tr>
        <th class="col-check"><input type="checkbox" id="check-all"></th>
        <th class="col-id">ID</th>
        <th class="col-sid">Sample ID</th>
        <th class="col-stat">Status</th>
        <th class="col-link">Link</th>
      </tr>
    </thead>
    <tbody>
      {% for s in samples %}
        <tr data-sample-id="{{ s.id }}">
          <td class="col-check"><input class="row-check" type="checkbox" value="{{ s.id }}"></td>
          <td class="col-id">{{ s.id }}</td>

          {# safe fallback: if sample_id is empty/None, show the object's __str__ #}
          <td class="col-sid">{{ s.sample_id|default:s }}</td>

          <td class="col-stat">
            <span class="pill">{{ s.status }}</span>
          </td>

          <td class="col-link"><a class="inline-link" href="/lims/ui/samples/{{ s.id }}/">open</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="5" style="padding:12px;">No samples found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  window.NAROLIMS_UI = window.NAROLIMS_UI || {};
  window.NAROLIMS_UI.bulkUrl = "/lims/workflows/sample/bulk/";
  window.NAROLIMS_UI.statusesUrl = "/lims/workflows/sample/";
  window.NAROLIMS_UI.labId = "{{ lab_id }}";
</script>
<script src="{% static 'lims_core/js/workflow_bulk.js' %}?v=4"></script>

{% endblock %}
