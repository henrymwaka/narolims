{% extends "lims_core/base.html" %}
{% load static %}

{% block title %}LIMS{% endblock %}
{% block page_title %}Workspace{% endblock %}
{% block page_meta %}Laboratory Information Management System{% endblock %}

{% block card_title %}Workspace overview{% endblock %}
{% block card_meta %}Operational modules, KPIs, activity, and alerts{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'lims_core/css/home.css' %}">
{% endblock %}

{% block content %}
<div class="dash">

  {% if wizard_first %}
    <div style="padding:16px;border:1px solid rgba(255,255,255,.12);border-radius:14px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div>
          <div style="font-weight:700;font-size:16px;">Start new work</div>
          <div style="opacity:.8;margin-top:2px;">
            No active project is available in your laboratory scope. Use the wizard to create a project and optionally pre-create samples.
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <a href="{% url 'lims_core:wizard:step1' %}" class="btn primary">Start a new project</a>
          <a href="{% url 'lims_core:wizard:step1' %}" class="btn">Create samples later</a>
        </div>
      </div>
    </div>
  {% endif %}

  <section class="dash-hero">
    <div class="dash-hero-top">
      <div class="dash-headline">
        <h2>Laboratory Information Management System</h2>
        <p>
          This workspace supports sample traceability, controlled workflow transitions, audit visibility, and integration-ready access.
          Start a new project, register samples, move them through controlled statuses, and preserve an evidence trail suitable for quality and compliance checks.
        </p>
      </div>

      <div class="dash-actions">
        <a class="btn primary" href="{% url 'lims_core:wizard:step1' %}">Start a new project</a>
        <a class="btn" href="/lims/ui/samples/">Samples</a>
        <a class="btn" href="/lims/ui/batches/">Batches</a>
        <a class="btn" href="/lims/ui/workflow-demo/">Workflow demo</a>
        {% if user.is_staff or user.is_superuser %}
          <a class="btn" href="/admin/">Admin</a>
        {% endif %}
      </div>
    </div>

    <div class="dash-note">
      <div class="who">
        Signed in as <b>{{ user.username }}</b><span id="labLabel"></span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <span class="dash-pill" id="sessionStatus">Session: active</span>
        <span class="dash-pill">Workspace</span>
      </div>
    </div>

    <form class="dash-form" onsubmit="return window.__openSampleById(event);">
      <div class="dash-field">
        <span class="dash-hint">Open by ID</span>
        <input id="sampleId" type="number" inputmode="numeric" min="1" placeholder="Sample ID (example: 18)">
      </div>
      <a class="btn" href="/lims/ui/samples/">Browse samples</a>
      <button class="btn primary" type="submit">Open</button>
    </form>
  </section>

  <section class="dash-grid">

    <div class="dash-card">
      <h3>Operational modules</h3>
      <div class="dash-muted" style="margin-top:6px;">
        Start from core areas. Each module is intended to be usable as a daily bench workspace.
      </div>

      <div class="dash-kpis">
        <div class="dash-kpi">
          <div class="label">Samples in system</div>
          <div id="kpiSamples" class="val">N/A</div>
          <div class="sub">Total registered samples</div>
        </div>
        <div class="dash-kpi">
          <div class="label">Experiments in system</div>
          <div id="kpiExperiments" class="val">N/A</div>
          <div class="sub">Total experiment records</div>
        </div>
      </div>

      <div class="dash-modules">

        <div class="dash-mod">
          <div class="dash-mod-top">
            <div class="dash-mod-name">Project wizard</div>
            <span class="dash-tag">Start here</span>
          </div>
          <div class="dash-mod-desc">
            Create a project for your laboratory and optionally pre-create placeholder samples so bench work can begin immediately.
          </div>
          <div class="dash-mod-actions">
            <a class="btn primary" href="{% url 'lims_core:wizard:step1' %}">Start</a>
            <a class="btn" href="{% url 'lims_core:wizard:step1' %}">Create samples later</a>
          </div>
        </div>

        <div class="dash-mod">
          <div class="dash-mod-top">
            <div class="dash-mod-name">Samples</div>
            <span class="dash-tag">Active</span>
          </div>
          <div class="dash-mod-desc">
            Register, track, and transition samples through controlled workflow states with audit visibility.
          </div>
          <div class="dash-mod-actions">
            <a class="btn primary" href="/lims/ui/samples/">Open</a>
            <a class="btn" href="/lims/workflows/sample/bulk/">Bulk status</a>
          </div>
        </div>

        <div class="dash-mod">
          <div class="dash-mod-top">
            <div class="dash-mod-name">Workflow control</div>
            <span class="dash-tag">Active</span>
          </div>
          <div class="dash-mod-desc">
            Validate workflow rules, role permissions, and allowed transitions using the demo widget and policy endpoints.
          </div>
          <div class="dash-mod-actions">
            <a class="btn primary" href="/lims/ui/workflow-demo/">Open demo</a>
            <a class="btn" href="/lims/workflows/permissions/sample/">Permissions</a>
          </div>
        </div>

        <div class="dash-mod">
          <div class="dash-mod-top">
            <div class="dash-mod-name">Inventory</div>
            <span class="dash-tag">Admin-first</span>
          </div>
          <div class="dash-mod-desc">
            Items and stock management. Admin entry and API access already work, UI can follow.
          </div>
          <div class="dash-mod-actions">
            <a class="btn" href="/admin/">Open admin</a>
            <a class="btn" href="/lims/inventory/">API endpoint</a>
          </div>
        </div>

        <div class="dash-mod">
          <div class="dash-mod-top">
            <div class="dash-mod-name">Reports and exports</div>
            <span class="dash-tag">Next</span>
          </div>
          <div class="dash-mod-desc">
            Compliance-ready outputs and operational summaries (turnaround time, exceptions, and audit extracts).
          </div>
          <div class="dash-mod-actions">
            <a class="btn" href="/lims/health/">System status</a>
            <a class="btn" href="/api/schema/swagger-ui/">API docs</a>
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h3>Recent activity</h3>
        <div class="dash-muted" style="margin-top:6px;">Latest workflow events and changes.</div>
        <ul class="dash-list" id="recentEvents">
          <li><span class="dash-badge">Info</span><span class="dash-item-muted">Loading...</span></li>
        </ul>
      </div>
    </div>

    <div>
      <div class="dash-card">
        <h3>Quick start</h3>
        <div class="dash-muted" style="margin-top:6px;">
          Common actions for day-to-day operations.
        </div>

        <div class="dash-quickgrid">

          {% if wizard_first %}
            <div class="dash-qa">
              <div class="title">Start new work</div>
              <div class="hint">Create a project first, then register or pre-create samples.</div>
              <div class="row">
                <a class="btn primary" href="{% url 'lims_core:wizard:step1' %}">Start wizard</a>
                <a class="btn" href="{% url 'lims_core:wizard:step1' %}">Project only</a>
              </div>
            </div>
          {% endif %}

          <div class="dash-qa">
            <div class="title">Review sample queue</div>
            <div class="hint">Filter by lab context and update workflow statuses.</div>
            <div class="row">
              <a class="btn primary" href="/lims/ui/samples/">Open queue</a>
              <a class="btn" href="/lims/workflows/sample/bulk/">Bulk update</a>
            </div>
          </div>

          <div class="dash-qa">
            <div class="title">Identity and access</div>
            <div class="hint">Confirm active roles and laboratory scope for this account.</div>
            <div class="row">
              <a class="btn" href="/lims/whoami/">Who am I</a>
              {% if user.is_staff or user.is_superuser %}
                <a class="btn" href="/admin/">Admin</a>
              {% endif %}
            </div>
          </div>

          <div class="dash-qa">
            <div class="title">System status and integrations</div>
            <div class="hint">Health check and API docs for external integrations.</div>
            <div class="row">
              <a class="btn" href="/lims/health/">Health</a>
              <a class="btn" href="/api/schema/swagger-ui/">Swagger</a>
              <a class="btn" href="/api/schema/redoc/">ReDoc</a>
            </div>
          </div>
        </div>
      </div>

      <div class="dash-card" style="margin-top:14px;">
        <h3>Attention</h3>
        <div class="dash-muted" style="margin-top:6px;">Exceptions and alerts.</div>
        <ul class="dash-list" id="openAlerts">
          <li><span class="dash-badge">Info</span><span class="dash-item-muted">Loading...</span></li>
        </ul>
      </div>
    </div>

  </section>
</div>

<script>
(function(){
  window.__openSampleById = function(ev){
    ev.preventDefault();
    const el = document.getElementById("sampleId");
    const id = (el && el.value) ? String(el.value).trim() : "";
    if (!id) return false;
    window.location.href = "/lims/ui/samples/" + encodeURIComponent(id) + "/";
    return false;
  };

  const kpiSamples = document.getElementById("kpiSamples");
  const kpiExperiments = document.getElementById("kpiExperiments");
  const labLabel = document.getElementById("labLabel");
  const recentEvents = document.getElementById("recentEvents");
  const openAlerts = document.getElementById("openAlerts");
  const sessionStatus = document.getElementById("sessionStatus");

  function listRow(kind, text){
    const li = document.createElement("li");
    const b = document.createElement("span");
    b.className = "dash-badge";
    b.textContent = kind;
    const t = document.createElement("span");
    t.className = "dash-item-text";
    t.textContent = text;
    li.appendChild(b);
    li.appendChild(t);
    return li;
  }

  function listMuted(text){
    const li = document.createElement("li");
    const b = document.createElement("span");
    b.className = "dash-badge";
    b.textContent = "Info";
    const t = document.createElement("span");
    t.className = "dash-item-muted";
    t.textContent = text;
    li.appendChild(b);
    li.appendChild(t);
    return li;
  }

  fetch("/lims/ui/stats/", {credentials: "same-origin"})
    .then(r => r.json())
    .then(data => {
      if (!data || data.ok === false){
        if(sessionStatus) sessionStatus.textContent = "Session: limited";
        if(kpiSamples) kpiSamples.textContent = "N/A";
        if(kpiExperiments) kpiExperiments.textContent = "N/A";
        if(recentEvents){
          recentEvents.innerHTML = "";
          recentEvents.appendChild(listMuted("Stats unavailable."));
        }
        if(openAlerts){
          openAlerts.innerHTML = "";
          openAlerts.appendChild(listMuted("Stats unavailable."));
        }
        return;
      }

      if (data.lab_id && labLabel){
        labLabel.textContent = " Â· Active lab: " + data.lab_id;
      }

      if(kpiSamples){
        kpiSamples.textContent =
          (data.stats && data.stats.samples_total != null) ? data.stats.samples_total : "N/A";
      }
      if(kpiExperiments){
        kpiExperiments.textContent =
          (data.stats && data.stats.experiments_total != null) ? data.stats.experiments_total : "N/A";
      }

      if(recentEvents){
        recentEvents.innerHTML = "";
        if (data.recent_events && data.recent_events.length){
          data.recent_events.slice(0, 6).forEach(e => {
            recentEvents.appendChild(listRow("Event", e.label || "Event"));
          });
        } else {
          recentEvents.appendChild(listMuted("No recent activity."));
        }
      }

      if(openAlerts){
        openAlerts.innerHTML = "";
        if (data.open_alerts && data.open_alerts.length){
          data.open_alerts.slice(0, 6).forEach(a => {
            openAlerts.appendChild(listRow("Alert", a.label || "Alert"));
          });
        } else {
          openAlerts.appendChild(listMuted("No open alerts."));
        }
      }
    })
    .catch(() => {
      if(sessionStatus) sessionStatus.textContent = "Session: limited";
      if(kpiSamples) kpiSamples.textContent = "N/A";
      if(kpiExperiments) kpiExperiments.textContent = "N/A";
      if(recentEvents){
        recentEvents.innerHTML = "";
        recentEvents.appendChild(listMuted("Stats unavailable."));
      }
      if(openAlerts){
        openAlerts.innerHTML = "";
        openAlerts.appendChild(listMuted("Stats unavailable."));
      }
    });
})();
</script>
{% endblock %}
